# Excel結合処理システム詳細設計書（マクロ・BAT・PAD版）

**文書情報**
- 作成日：2025年7月16日
- バージョン：2.0
- 文書種別：詳細設計書
- 実装方式：Excelマクロ + BATファイル + Power Automate Desktop
- 関連文書：Excel結合処理システム要件定義書 v1.0

---

## 1. システム構成

### 1.1 全体構成図

```
┌────────────────────────────────────────────────────────────────┐
│              Excel結合処理システム（マクロベース）                  │
├────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐                                              │
│  │ 起動BAT      │  ①ドラッグ&ドロップ                           │
│  │ (Start.bat)  │←─────────── Excel1.xlsx + Excel2.xlsx      │
│  └──────┬───────┘                                              │
│         │②起動                                                  │
│         ↓                                                       │
│  ┌──────────────┐     ③読込      ┌─────────────┐            │
│  │マスタExcel    │←───────────────→│ 設定シート   │            │
│  │(処理エンジン) │                 │(Config)     │            │
│  │ *.xlsm       │                 └─────────────┘            │
│  └──────┬───────┘                                              │
│         │④マクロ実行                                            │
│         ↓                                                       │
│  ┌──────────────────────────────────────────┐                │
│  │  VBAマクロ処理                          │                │
│  │  ├─ FileHandler (ファイル処理)         │                │
│  │  ├─ DataProcessor (データ結合)         │                │
│  │  ├─ Logger (ログ処理)                 │                │
│  │  └─ OutputGenerator (出力生成)         │                │
│  └────────────┬─────────────────────────┘                │
│               │⑤出力                                           │
│               ↓                                                │
│  ┌──────────────┐                                             │
│  │ 結合Excel    │  ・データシート                               │
│  │ *.xlsx      │  ・ログシート                                 │
│  └──────────────┘                                             │
└────────────────────────────────────────────────────────────────┘

※複雑な処理が必要な場合のみPower Automate Desktop連携
```

### 1.2 ファイル構成

```
excel-merge-system/
├── Start.bat                    # 起動用バッチファイル
├── ExcelMergeEngine.xlsm       # マクロ実行エンジン（マスタ）
├── Config/                     # 設定フォルダ
│   └── MergeConfig.xlsx        # 設定ファイル
├── Input/                      # 入力ファイル格納（任意）
├── Output/                     # 出力ファイル格納
├── Logs/                       # ログファイル格納
└── PAD/                        # Power Automate Desktop用
    └── ExcelMergeSupport.pad   # 補助処理フロー
```

---

## 2. マクロ設計（ExcelMergeEngine.xlsm）

### 2.1 モジュール構成

```
ExcelMergeEngine.xlsm
├── ThisWorkbook              # ワークブックイベント
├── modMain                   # メイン処理
├── modFileHandler           # ファイル入出力
├── modDataProcessor         # データ処理
├── modLogger               # ログ処理
├── modConfig               # 設定管理
├── modValidator            # 検証処理
└── modPADConnector         # PAD連携（必要時）
```

### 2.2 主要モジュール詳細

#### 2.2.1 modMain - メイン処理

#### 2.2.2 modFileHandler - ファイル処理

## 3. バッチファイル設計

### 3.1 Start.bat - 起動用バッチファイル

## 4. 設定ファイル設計

### 4.1 MergeConfig.xlsx - 設定ファイル構造

**シート: Config**

| 設定項目 | 値 | 説明 |
|----------|-----|------|
| Excel1_HeaderRows | 3 | Excel1のヘッダー行数 |
| Excel1_DataStartRow | 4 | Excel1のデータ開始行 |
| Excel1_IDColumn | B | Excel1の識別コード列 |
| Excel1_FilePattern | *顧客* | Excel1のファイル識別パターン |
| Excel2_HeaderRows | 2 | Excel2のヘッダー行数 |
| Excel2_DataStartRow | 3 | Excel2のデータ開始行 |
| Excel2_IDColumn | A | Excel2の識別コード列 |
| Excel2_FilePattern | *売上* | Excel2のファイル識別パターン |
| Output_FileNameFormat | 結合データ_[DATE].xlsx | 出力ファイル名形式 |
| Output_Directory | .\Output | 出力ディレクトリ |
| Output_IncludeLogSheet | TRUE | ログシート含む |
| Processing_MaxRows | 100000 | 最大処理行数 |

---

## 5. Power Automate Desktop連携設計

### 5.1 PAD使用ケース

以下の場合にPADを使用：

1. **大量データ処理（10万行超）**
   - メモリ効率的な処理が必要な場合
   
2. **複雑なファイル操作**
   - 複数フォルダからのファイル収集
   - ネットワークドライブアクセス

3. **エラー通知**
   - メール送信
   - Teams通知

### 5.2 PADフロー設計

```
Main
├─ Input
│  ├─ Get command line arguments
│  └─ Validate inputs
├─ Process
│  ├─ If rows > 100000
│  │  ├─ Split file processing
│  │  └─ Merge results
│  └─ Else
│      └─ Call Excel macro
├─ Output
│  └─ Send notification (if configured)
└─ Error Handling
   └─ Log error and notify
```

### 5.3 VBAからPAD呼び出し

```vba
'--------------------------------------------------
' PAD実行（必要時のみ）
'--------------------------------------------------
Private Function ExecutePAD(ByVal flowName As String, _
                          ByVal parameters As String) As Boolean
    
    Dim shell As Object
    Dim command As String
    Dim result As Long
    
    Set shell = CreateObject("WScript.Shell")
    
    ' PADコマンドライン構築
    command = """C:\Program Files (x86)\Power Automate Desktop\PAD.Console.exe"" " & _
              "-Flow """ & flowName & """ " & parameters
    
    ' 実行
    result = shell.Run(command, 1, True)
    
    ExecutePAD = (result = 0)
    
End Function
```

---

## 6. エラー処理設計

### 6.1 エラー処理フロー

```
エラー発生
├─ VBAエラーハンドラ
│  ├─ エラー内容記録
│  ├─ 処理継続判定
│  └─ ユーザー通知
├─ バッチエラー処理
│  ├─ 終了コード設定
│  └─ エラーメッセージ表示
└─ PADエラー処理（使用時）
   ├─ エラーログ記録
   └─ 通知送信
```

### 6.2 エラーメッセージ一覧

| エラーコード | メッセージ | 対処方法 |
|-------------|-----------|----------|
| E001 | ファイルが見つかりません | ファイルパスを確認 |
| E002 | ファイルアクセスエラー | ファイルが使用中でないか確認 |
| E003 | 識別コード列が見つかりません | 設定ファイルの列設定を確認 |
| E004 | メモリ不足 | データ量を減らすかPAD処理を使用 |
| E005 | 出力先にアクセスできません | 出力フォルダの権限を確認 |

---

## 7. パフォーマンス考慮事項

### 7.1 VBAマクロの最適化

1. **画面更新の抑制**
   ```vba
   Application.ScreenUpdating = False
   Application.Calculation = xlCalculationManual
   Application.EnableEvents = False
   ```

2. **配列処理の活用**
   - セル単位でなく配列で一括読み書き
   - Variant配列の使用

3. **Dictionaryオブジェクトの活用**
   - 高速な検索処理
   - 重複チェックの効率化

### 7.2 処理量による分岐

| データ量 | 処理方法 | 理由 |
|---------|---------|------|
| ～1万行 | VBAマクロのみ | 十分高速 |
| 1万～10万行 | VBAマクロ（最適化） | 配列処理で対応可能 |
| 10万行超 | PAD連携 | メモリ制限回避 |

---

## 8. 運用設計

### 8.1 運用フロー

```
1. 事前準備
   ├─ ExcelMergeEngine.xlsmの配置
   ├─ MergeConfig.xlsxの設定
   └─ フォルダ構成の確認

2. 実行
   ├─ Excel1とExcel2を準備
   ├─ Start.batにドラッグ&ドロップ
   └─ 処理完了待機

3. 結果確認
   ├─ 出力ファイル確認
   ├─ ログシート確認
   └─ エラー有無の確認

4. 後処理
   └─ 必要に応じて出力ファイルを移動
```

### 8.2 トラブルシューティング

| 症状 | 原因 | 対処方法 |
|------|------|----------|
| マクロが実行されない | セキュリティ設定 | マクロを有効化 |
| 処理が遅い | データ量過多 | PAD処理に切替 |
| 文字化け | 文字コード不一致 | UTF-8で統一 |
| メモリエラー | 大量データ | 64bit版Excel使用 |

---

## 9. セキュリティ考慮事項

### 9.1 マクロセキュリティ

1. **信頼できる場所の設定**
   - システムフォルダを信頼できる場所に追加

2. **デジタル署名**
   - 必要に応じてマクロにデジタル署名

3. **最小権限の原則**
   - 必要最小限のフォルダアクセス

### 9.2 データ保護

1. **元ファイルの保護**
   - 読み取り専用でオープン
   - 変更を加えない

2. **ログ情報の管理**
   - 個人情報のマスキング
   - 適切なアクセス制限

---

## 10. テスト計画

### 10.1 単体テスト

| テスト項目 | テスト内容 | 期待結果 |
|-----------|-----------|----------|
| ファイル読込 | 各種フォーマット | 正常読込 |
| データ結合 | 様々なパターン | 正確な結合 |
| エラー処理 | 異常系 | 適切なエラー |

### 10.2 統合テスト

1. **正常系シナリオ**
   - 小規模データ（100件）
   - 中規模データ（1万件）
   - 大規模データ（10万件）

2. **異常系シナリオ**
   - ファイル不在
   - アクセス権限なし
   - 破損ファイル

### 10.3 性能テスト

| データ量 | 目標処理時間 |
|---------|-------------|
| 1,000件 | 10秒以内 |
| 10,000件 | 30秒以内 |
| 100,000件 | 5分以内 |

---

## 11. 実装例

### 11.1 出力ファイル生成処理

### 11.2 設定読込処理

## 13. 導入手順

### 13.1 初期セットアップ

1. **ファイル配置**
   ```
   1. excel-merge-systemフォルダを作成
   2. 各ファイルを配置
   3. Config, Output, Logsフォルダを作成
   ```

2. **Excel設定**
   ```
   1. マクロを有効化
   2. 信頼できる場所に追加
   3. 参照設定確認
   ```

3. **設定ファイル編集**
   ```
   1. MergeConfig.xlsxを開く
   2. 各パラメータを設定
   3. 保存して閉じる
   ```

### 13.2 動作確認

1. **テストデータ準備**
   - サンプルExcel1.xlsx
   - サンプルExcel2.xlsx

2. **実行テスト**
   - Start.batにドラッグ&ドロップ
   - 正常終了確認

3. **結果確認**
   - 出力ファイル確認
   - ログ内容確認

---

## 14. まとめ

本設計書では、ExcelマクロとBATファイルを中心とした実装方式を採用し、以下を実現します：

1. **シンプルな操作性**
   - ドラッグ&ドロップで実行
   - 設定ファイルによる柔軟性

2. **十分な性能**
   - 10万行まではVBAで処理
   - それ以上はPAD連携

3. **高い保守性**
   - モジュール化設計
   - 詳細なログ機能

4. **拡張性**
   - 将来の機能追加に対応
   - 外部連携可能

この設計により、要件定義書の内容を満たしつつ、実用的なシステムの構築が可能です。

---

## 15. 承認

本詳細設計書は、要件定義書に基づき、Excelマクロ・BAT・PADを活用した実装方式で作成されています。

作成日：2025年7月16日

設計者：_________________

承認者：_________________